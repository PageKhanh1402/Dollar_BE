@model DollarProject.Models.SellerStore
@using System.Security.Claims

@{
    ViewData["Title"] = "Your Store";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var currentUserId = int.Parse(User.FindFirstValue("UserId") ?? "0");
    var isAdmin = User.IsInRole("Admin") || User.IsInRole("Staff");
}

<section class="section-pt overflow-visible">
    <div class="container">
        <div class="relative w-full h-[200px] rounded-xl overflow-hidden shadow-xl mb-14">
            <img src="@(Model?.BannerURL ?? "default-banner.jpg")"
                 class="w-full h-full object-cover object-center" alt="Store Banner" />
        </div>

        <div class="text-center -mt-16">
            <img src="@(Model?.LogoURL ?? "default-logo.png")"
                 class="w-24 h-24 object-cover rounded-full border-4 border-white shadow-lg mx-auto" alt="Store Logo" />
            <h1 class="text-white text-3xl font-bold mt-4 drop-shadow-md">@Model.StoreName</h1>
            <p class="text-white text-base italic drop-shadow mt-2">@Model.Description</p>
        </div>

        <!-- Product Post button -->
        <div class="bg-b-neutral-3 rounded-xl shadow-md p-4 mt-4 mb-10">
            <button id="openPostModal"
                    class="w-full flex items-center gap-4 text-left bg-gray-800 border border-gray-600 hover:border-orange-500 transition rounded-2xl px-6 py-5 text-white hover:bg-gray-700 shadow-lg"
                    style="font-family: 'Poppins', sans-serif; font-style: italic; font-weight: 300;">
                <img src="@(Model?.LogoURL ?? "default-logo.png")" class="w-12 h-12 rounded-full border-2 border-white shadow" alt="Your Avatar" />
                <span class="text-gray-400 text-lg">What's your product? Sell something now...</span>
            </button>
        </div>
        <!-- Modal wrapper -->
        <div id="postProductModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-start justify-center overflow-y-auto pt-20">
            <div class="bg-gray-900 p-6 sm:p-8 rounded-2xl w-full max-w-4xl relative">
                <button id="closePostModal" class="absolute top-2 right-3 text-white text-xl">×</button>
                @await Html.PartialAsync(
                         "~/Views/Product/_CreateProductPartial.cshtml",
                         new DollarProject.Models.Product(),
                         new ViewDataDictionary(new Microsoft.AspNetCore.Mvc.ModelBinding.EmptyModelMetadataProvider(), new Microsoft.AspNetCore.Mvc.ModelBinding.ModelStateDictionary())
                {
                { "Categories", ViewBag.Categories }
                }
                         )
            </div>
        </div>

        <!-- Product Listing -->
        <div class="bg-b-neutral-3 p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-w-neutral-1 mb-6">Products</h2>

            @if (Model.Products != null && Model.Products.Any())
            {
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    @foreach (var product in Model.Products)
                    {
                        var isOwner = product.SellerID == currentUserId;

                        <div class="bg-gradient-to-br from-[#2d2d2d] via-[#3b3b3b] to-[#1f1f1f] rounded-xl shadow-lg overflow-hidden hover:scale-105 transform transition duration-300">
                            <img src="@Url.Content(product.ImageURL ?? "default-product.png")"
                                 class="w-full h-52 object-cover border-b border-gray-700" alt="@product.ProductName" />
                            <div class="p-4 text-white">
                                <h3 class="text-lg font-semibold">@product.ProductName</h3>
                                <p class="text-sm text-gray-300 mb-2">@product.Description</p>

                                @* 🔐 Only show Account Information for owner or admin/staff *@
                                @if (isOwner || isAdmin)
                                {
                                    <p class="text-sm text-orange-400 mt-1">
                                        <strong>Account Info:</strong> @product.AccountInfomation
                                    </p>
                                }

                                <div class="flex justify-between items-center mt-3">
                                    <span class="bg-yellow-500 text-black text-sm font-semibold px-3 py-1 rounded-full">
                                        @product.PriceXu.ToString("N0") Xu
                                    </span>
                                    <span class="text-xs bg-white text-black px-2 py-1 rounded">@product.ProductType</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-gray-400 italic">No products available.</p>
            }
        </div>
    </div>
</section>

                                    @section Scripts {
    <script>
        const modal = document.getElementById("postProductModal");
        const openBtn = document.getElementById("openPostModal");
        const closeBtn = document.getElementById("closePostModal");

        openBtn?.addEventListener("click", () => {
            modal.classList.remove("hidden");
            modal.classList.add("flex");
        });

        closeBtn?.addEventListener("click", () => {
            modal.classList.add("hidden");
        });

        window.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.classList.add("hidden");
            }
        });
    </script>
}
