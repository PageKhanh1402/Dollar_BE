@using System.Security.Claims
<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <title>TradeMax Arena</title>
    <script defer src="/js/app.js"></script>
    <link href="~/css/app.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="~/css/loginStyle.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>

</head>
<body>
    <!-- preloader start -->
    <div class="preloader">
        <div class="loader"></div>
    </div>
    <!-- preloader end -->
    <!-- scroll to top button start -->
    <button class="scroll-to-top show" id="scrollToTop">
        <i class="ti ti-arrow-up"></i>
    </button>
    <!-- scroll to top button end -->
    <!-- header start -->
    <header id="header" class="absolute w-full z-[999]">
        <div class="mx-auto relative">
            <div id="header-nav" class="w-full px-24p bg-b-neutral-3 relative">
                <div class="flex items-center justify-between gap-x-2 mx-auto py-20p">
                    <nav class="relative xl:grid xl:grid-cols-12 flex justify-between items-center gap-24p text-semibold w-full">
                        <div class="3xl:col-span-6 xl:col-span-5 flex items-center 3xl:gap-x-10 gap-x-5">
                            <a asp-controller="Home" asp-action="Index" class="shrink-0">
                                <img class="xl:w-[170px] sm:w-36 w-30 h-auto shrink-0" src="/images/logo.png" alt="brand">
                            </a>
                            <form class="hidden lg:flex items-center sm:gap-3 gap-2 min-w-[300px] max-w-[670px] w-full px-20p py-16p bg-b-neutral-4 rounded-full">
                                <span class="flex-c icon-20 text-white">
                                    <i class="ti ti-search"></i>
                                </span>
                                <input autocomplete="off" class="bg-transparent w-full" type="text" name="search" id="search" placeholder="Search...">
                            </form>

                        </div>
                        <div class="3xl:col-span-6 xl:col-span-7 flex items-center justify-end w-full">
                            <div class="hidden lg:flex items-center gap-3 shrink-0 ml-4">
                                <!-- Cửa hàng -->
                                <a asp-controller="SellerStore" asp-action="Index" class="btn-c btn-c-lg btn-c-dark-outline">
                                    <svg fill="#ebeaea" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="84px" height="84px" viewBox="-245.5 -245.5 982.00 982.00" xml:space="preserve" stroke="#ebeaea" transform="matrix(1, 0, 0, 1, 0, 0)">
                                    <g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                    <g id="SVGRepo_iconCarrier"> <g> <g> 
                                    <path d="M82.695,159.575V112.3c6.321-5.45,10.337-13.498,10.337-22.499c0-16.412-13.306-29.718-29.719-29.718 c-16.412,0-29.718,13.306-29.718,29.718c0,9.001,4.016,17.048,10.337,22.499v47.275H82.695z"></path> <path d="M444.484,159.575V112.3c6.32-5.45,10.337-13.498,10.337-22.499c0-16.412-13.307-29.718-29.72-29.718 c-16.412,0-29.719,13.306-29.719,29.718c0,9.001,4.017,17.048,10.337,22.499v47.275H444.484z"></path> 
                                    <polygon points="188.296,317.212 212.417,317.212 200.294,277.735 "></polygon> 
                                    <path d="M405.721,172.496H82.695H43.932H0v258.421h491V172.496h-46.516H405.721z M129.019,342.578 c-3.895,5.944-9.339,10.45-16.329,13.521c-6.991,3.069-15.805,4.607-26.442,4.607c-18.676,0-31.61-3.596-38.802-10.787 c-7.192-7.191-11.262-16.329-12.21-27.415l32.285-2.021c0.701,5.242,2.122,9.238,4.27,11.984c3.496,4.445,8.489,6.668,14.98,6.668 c4.843,0,8.577-1.138,11.197-3.408c2.621-2.271,3.934-4.908,3.934-7.902c0-2.846-1.249-5.395-3.745-7.643 c-2.497-2.248-8.291-4.369-17.379-6.367c-14.882-3.347-25.494-7.791-31.835-13.334c-6.393-5.543-9.588-12.608-9.588-21.198 c0-5.644,1.636-10.976,4.908-15.993c3.271-5.02,8.189-8.966,14.756-11.836c6.566-2.871,15.567-4.309,27.005-4.309 c14.032,0,24.73,2.609,32.098,7.828c7.365,5.219,11.748,13.521,13.146,24.905l-31.985,1.874c-0.85-4.943-2.633-8.538-5.357-10.786 c-2.721-2.248-6.479-3.371-11.272-3.371c-3.946,0-6.915,0.839-8.913,2.511c-1.998,1.672-2.995,3.709-2.995,6.106 c0,1.746,0.824,3.32,2.473,4.718c1.597,1.448,5.393,2.797,11.386,4.045c14.831,3.196,25.457,6.43,31.874,9.701 s11.086,7.329,14.006,12.172c2.92,4.846,4.383,10.262,4.383,16.256C134.862,330.144,132.914,336.638,129.019,342.578z M224.951,358.56l-5.494-18.09h-38.528l-5.357,18.09H140.93l41.275-108.537h37.014L260.48,358.56H224.951z M359.205,358.56 h-87.863V250.022h33.595v82.693h54.27L359.205,358.56L359.205,358.56z M465.158,250.022v23.258h-56.854v15.505h51.685v23.258 h-51.685v20.674h56.854v25.843h-90.447V250.022H465.158z"></path></g> </g> </g>
                                    </svg>
                                </a>



                                <!-- Thông báo -->
                                <div class="relative hidden lg:block mb-1">
                                    <a href="chat.html" class="btn-c btn-c-lg btn-c-dark-outline">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M10 5a2 2 0 1 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6"></path>
                                            <path d="M9 17v1a3 3 0 0 0 6 0v-1"></path>
                                        </svg>
                                    </a>
                                </div>
                                @if (!User.Identity.IsAuthenticated)
                                {
                                    <!-- Button Login -->
                                    <button id="loginButton" class="login-btn flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
                                            <path d="M20 12h-13l3 -3m0 6l-3 -3" />
                                        </svg>
                                        <span>Login</span>
                                    </button>
                                }
                                else
                                {
                                    <div x-data="dropdown" class="dropdown relative shrink-0 lg:block hidden">
                                        <button @@click="toggle()" class="dropdown-toggle gap-24p">
                                            <span class="flex items-center gap-3">
                                                @{
                                                    var image = User.FindFirstValue("ImageUrl");
                                                }
                                                <img class="size-48p rounded-full shrink-0" src="/images/@User.FindFirstValue("ImageUrl")" alt="profile">
                                                <span class="">
                                                    <span class="text-m-medium text-w-neutral-1 mb-1">@User.FindFirstValue(ClaimTypes.GivenName)</span>
                                                    <span class="text-sm text-w-neutral-4 block">options</span>
                                                </span>
                                            </span>
                                            <span :class="isOpen ? '-rotate-180' : ''" class="btn-c btn-c-lg text-w-neutral-4 icon-32 transition-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon">
                                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                                    <path d="M6 9l6 6l6 -6"></path>
                                                </svg>
                                            </span>
                                        </button>
                                        <div x-show="isOpen" x-transition="" @@click.away="close()" class="dropdown-content">

                                            <a asp-controller="Profile" asp-action="Index" class="dropdown-item">Profile</a>
                                            <a href="./user-settings.html" class="dropdown-item">Settings</a>

                                            <form asp-controller="Auth" asp-action="Logout" method="post" id="logoutForm">
                                                <button type="submit" class="dropdown-item">Logout</button>
                                            </form>
                                            <a href="#" class="dropdown-item">Help</a>
                                        </div>
                                    </div>
                                }
                                <button class="lg:hidden btn-c btn-c-lg btn-c-dark-outline nav-toggole shrink-0">
                                    <i class="ti ti-menu-2"></i>
                                </button>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>
            @if (!User.Identity.IsAuthenticated)
            {
                <!-- Login Modal Wrapper -->
                <div id="loginWrapper" class="login-modal-wrapper fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]">
                    @await Html.PartialAsync("~/Views/Auth/_LoginPartial.cshtml", new DollarProject.ViewModels.LoginViewModel())
                </div>
            }
        </div>
    </header>
    <!-- header end -->
    <!-- sidebar start -->
    <div>
        <div class="fixed top-0 left-0 lg:translate-x-0 -translate-x-full h-screen z-30 bg-b-neutral-4 pt-30 px-[27px] transition-1">
            <div class="max-h-screen overflow-y-auto scrollbar-0">
                <div class="flex flex-col items-center xxl:gap-[30px] xl:gap-6 lg:gap-5 gap-4 h-[700px] side-navbar-one">
                    <button class="nav-toggole btn-c btn-c-3xl btn-primary icon-32 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M4 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                            <path d="M14 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                            <path d="M4 14m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                            <path d="M14 14m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z"></path>
                        </svg>
                    </button>
                    <div class="flex flex-col gap-2 rounded-full bg-b-neutral-1 w-fit p-2 shrink-0">
                        <a asp-controller="Home" asp-action="Index" class="nav-item btn-c btn-c-3xl text-white transition-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M12 10.941c2.333 -3.308 .167 -7.823 -1 -8.941c0 3.395 -2.235 5.299 -3.667 6.706c-1.43 1.408 -2.333 3.621 -2.333 5.588c0 3.704 3.134 6.706 7 6.706s7 -3.002 7 -6.706c0 -1.712 -1.232 -4.403 -2.333 -5.588c-2.084 3.353 -3.257 3.353 -4.667 2.235"></path>
                            </svg>
                        </a>
                        <a asp-controller="Marketplace" asp-action="Index" class="nav-item btn-c btn-c-3xl">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M6 5h12l3 5l-8.5 9.5a.7 .7 0 0 1 -1 0l-8.5 -9.5l3 -5"></path>
                                <path d="M10 12l-2 -2.2l.6 -1"></path>
                            </svg>
                        </a>
                        <a asp-controller="Wishlist" asp-action="Index" class="nav-item btn-c btn-c-3xl text-white transition-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M18 7v14l-6 -4l-6 4v-14a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4z"></path>
                            </svg>
                        </a>
                        <a asp-controller="Chat" asp-action="Index" class="nav-item btn-c btn-c-3xl">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M21 14l-3 -3h-7a1 1 0 0 1 -1 -1v-6a1 1 0 0 1 1 -1h9a1 1 0 0 1 1 1v10"></path>
                                <path d="M14 15v2a1 1 0 0 1 -1 1h-7l-3 3v-10a1 1 0 0 1 1 -1h2"></path>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- sidebar end -->
    <!-- app layout start -->
    <div class="app-layout">
        <!-- main start -->
        @RenderBody()
        <!-- main end -->
        <!-- footer-->
        @await Html.PartialAsync("_Footer")
    </div>
    <!-- app layout end -->
    @RenderSection("Scripts", required: false)
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script>
        // Handle login button
        document.getElementById("loginButton").addEventListener("click", function () {
            document.getElementById("loginWrapper").classList.remove("hidden");
            document.getElementById("loginWrapper").classList.add("show");
            document.querySelector(".app-layout").classList.add("blur");
        });

        // Handle close login modal
        document.getElementById("closeLogin").addEventListener("click", function () {
            document.getElementById("loginWrapper").classList.remove("show");
            document.getElementById("loginWrapper").classList.add("hidden");
            document.querySelector(".app-layout").classList.remove("blur");
        });

        // Handle click outside modal
        document.getElementById("loginWrapper").addEventListener("click", function (e) {
            if (e.target === this) {
                this.classList.remove("show");
                this.classList.add("hidden");
                document.querySelector(".app-layout").classList.remove("blur");
            }
        });

            // Auto mở modal nếu có ?showLogin=true
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('showLogin') === 'true') {
                document.getElementById("loginWrapper").classList.remove("hidden");
                document.getElementById("loginWrapper").classList.add("show");
                document.querySelector(".app-layout").classList.add("blur");
            }

        // Handle submit form login
        document.getElementById("loginForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const form = this;
            const formData = new FormData(form);
            fetch(form.action, {
                method: form.method,
                body: formData
            })
                .then(response => response.json().then(data => ({ status: response.status, data })))
                .then(({ status, data }) => {
                    if (status === 200 && data.success) {
                        window.location.href = data.redirectUrl;
                    } else {
                        const errorContainer = document.querySelector(".text-danger");
                        errorContainer.innerHTML = data.errors.map(error => `<p>${error}</p>`).join("");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        // Handle logout
        document.getElementById("logoutForm")?.addEventListener("submit", function (e) {
            e.preventDefault();
            // Clear Google session by redirecting to Google's logout endpoint
            fetch(this.action, {
                method: this.method,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
                .then(response => {
                    if (response.ok) {
                        // Redirect to Google logout to clear session
                        window.location.href = 'https://accounts.google.com/Logout?continue=' + encodeURIComponent(window.location.origin);
                    }
                })
                .catch(error => {
                    console.error('Logout Error:', error);
                });
        });

        // Handle Google Sign-In callback
        window.addEventListener('load', function () {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') || urlParams.has('error')) {
                // Only process callback if not just logged out
                if (!sessionStorage.getItem('justLoggedOut')) {
                    fetch(`/Auth/ExternalLoginCallback?returnUrl=${encodeURIComponent(urlParams.get('returnUrl') || '/')}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.href = data.redirectUrl;
                            } else {
                                document.getElementById("loginWrapper").classList.remove("hidden");
                                document.getElementById("loginWrapper").classList.add("show");
                                document.querySelector(".app-layout").classList.add("blur");
                                const errorContainer = document.querySelector(".text-danger");
                                errorContainer.innerHTML = data.errors.map(error => `<p>${error}</p>`).join("");
                            }
                        })
                        .catch(error => {
                            console.error('Google Sign-In Error:', error);
                            document.getElementById("loginWrapper").classList.remove("hidden");
                            document.getElementById("loginWrapper").classList.add("show");
                            document.querySelector(".app-layout").classList.add("blur");
                            const errorContainer = document.querySelector(".text-danger");
                            errorContainer.innerHTML = '<p>Google Sign-In failed. Please try again.</p>';
                        });
                } else {
                    // Clear justLoggedOut flag
                    sessionStorage.removeItem('justLoggedOut');
                }
            }
        });
    </script>

</body>
</html>